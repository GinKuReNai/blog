---
title: Cloudfront Continuous DistributionでECS環境でブルーグリーンデプロイする
description: ECS環境でのブルーグリーンデプロイで、Cloudfrontを利用してブルーグリーンデプロイのステージング環境にルーティングする機会があったので共有します。
pubDatetime: 2024-04-22T21:00:00+09:00
modDatetime: 2024-04-22T21:00:00+09:00
author: "Akito Koga"
slug: slug
featured: false
draft: false
tags: [AWS]
---

こんにちは。

AWSにおけるECSとCodeDeployを使用してブルーグリーンデプロイの環境を整えていたのですが、ブルーグリーンデプロイ環境では通常、ステージング環境がデプロイ時に用意できます。
Cloudfrontを利用した環境において、本番環境とステージング環境で相互にルーティングするために、Cloudfront Continuous Distributionを利用すると便利でした。
今回はそちらを実装する機会があったので、その備忘録も兼ねて共有です。

## Table of Contents

## ブルーグリーンデプロイにおけるステージング環境

ブルーグリーンデプロイでは、デプロイ時に新しいグリーン環境を立ち上げて、ロードバランサーのターゲットをブルー環境からグリーン環境に切り替えることによって、瞬時にソフトウェアを更新することができるデプロイ方法です。
そのようにすることによって、ソフトウェアの瞬時切り替えが可能になるだけでなく、カナリアリリースのように任意の割合だけ新環境にターゲットを向けるような、高度な切り替えも行うことができます。

ブルーグリーンデプロイでグリーン環境が立ち上がった後、実際にユーザーからのトラフィックをグリーン環境に向ける前に、開発者はグリーン環境をステージング環境として利用することができます。
そのようなフェーズを挟むことによって、リリース予定の新機能が本番環境で実際に動作しているのか確認することができます。

通常、ブルー環境には80番ポート、グリーン環境には10080番ポートをそれぞれ割り当てて、開発者は指定するポートを切り替えることによって、ステージング環境にアクセスすることができます。

デプロイ前は80番も10080番もブルー環境をターゲットにしているのですが、デプロイ時に10080番がグリーン環境をターゲットに切り替えます。
ブルー環境は80番の状態のままなので、デプロイの時点ではユーザーからのトラフィックは本番環境にしか向けられていません。
ステージング環境での動作確認が終了したら、グリーン環境にユーザーからのトラフィックを流していきます。

これが、ブルーグリーンデプロイでのステージング環境の一般的な利用の説明です。

## Cloudfrontでのツラミ

しかし、ALBの前段にCDNとしてCloudfrontを立てた場合に、用意にステージング環境にアクセスさせるための方法がありませんでした。

Cloudfrontは複数のオリジンを登録することができます。ですので、80番ポートのリスナーと、10080番ポートのリスナーを別々のオリジンサーバーとして登録して、適切にルーティングさせることができれば良いと思うかもしれません。

しかし、Cloudfrontのルーティングはパスルーティングです。ポート番号を変えることでルーティングさせることができません。

無理やりパスを変更する手もなくはないのですが、本番環境とステージング環境でパスが違うというのは色々な意味で制約が発生しますし、ソフトウェアの動作を確認したいのに本番相当の動作ができなければ本末転倒です。

なので、今まではCloudfrontを用いる場合はDNSレコードに新たに登録するといった、少し煩雑な実装が求められていました。

## Cloudfront Continuous Distribution

という感じで、Cloudfrontを通したECSのブルーグリーンデプロイは割とツラミが多く、私もどうやって実現させようかと考えていました。

そのような中で、Cloudfront Continuous DistributionはECSのブルーグリーンデプロイにおけるステージング環境と連携する手段としてとても最適でした。

仕組みとしては、Cloudfrontのディストリビューションを本番環境とステージング環境で2つ用意します。ステージング環境は本番環境と紐付けされています。

ステージング環境への切り替えとして、`aws-cf-cd-`から始まる追加のリクエストヘッダーを用意して、ヘッダーの有無でCloudfrontのディストリビューションを切り替えることができます。

## 実際の注意

`aws-cf-cd-`から始まる追加のリクエストヘッダーはChromeなどのブラウザの拡張機能を用いて付与するのが一番簡単です。しかし、Chromeの拡張機能を色々と調べてみたのですが、正直言ってセキュリティ的に怪しい拡張機能しかない。

これは困ったと色々と探していたのですが、[Requestly](https://requestly.com/)という拡張機能を発見しました。こちらは信頼性の高い拡張機能として使用することができそうです。

また、私が実装した環境ではフロントエンドにNext.js、バックエンドにWeb APIを使用するような構成でアプリケーションを構成していました。
バックエンドAPIにブルーグリーンデプロイを適用していたので、フロントエンドが追加のリクエストヘッダーを中継する必要がありました。
ブルーグリーンデプロイを適用するのがAPIで、フロントと完全に切り離して運用している場合、リクエストヘッダーを中継してあげる必要があるので注意が必要です。

最後に、ALBのセキュリティグループとしてCloudfrontのマネージドプレフィックスリストを適用する必要があるのですが、80番と10080番で2つのSGのインバウンドルールを適用する必要があります。
しかし、AWSのSGのルールの上限数は60です。マネージドプレフィックスリストのエントリ数が55なので、80番に一つインバウンドルールを適用すると、残りの使えるルール数は5つしかありません。

ですので、10080番にもSGのルールを適用するためには、AWSにSGのルール数の上限を110以上に引き上げるように申請しなくてはなりません。MAXで200です。

特にTerraformなどのIaCで構成管理をしている場合に、SGのルール上限数でapplyできない場合はこちらに引っかかっている可能性が高いので、確認してみてください。

## まとめ

Cloudfront Continuous Distributionを使用して、ECSのブルーグリーンデプロイにおけるステージング環境に追加ヘッダーを用いてルーティングを切り替える方法について説明しました。

私自身使用する際にうまくいくのか疑問だったのですが、驚くほどスムーズに動作確認することができて驚きました。以前は使用できなかった機能ですので、AWSが枝葉の細かいニーズに着々と対応しているのは感謝です。

ただし、Cloudfront Continuous Distributionを使うにあたり、構成が複雑になるので注意が必要です。実装する際はCloudfrontを利用するのが本当に適切なのかも踏まえて、実装するアプリケーションの要件に合わせて選択しましょう。
